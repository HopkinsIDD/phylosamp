---
title: <font size="5">An introduction to the phylosamp package</font>
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Put the title of your vignette here}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir="../")
knitr::opts_chunk$set(fig.width=7.5, fig.height=6, fig.path='../figures/', warning=FALSE, message=FALSE,cache=FALSE)

library(phylosamp)
```

## Overview

This vignette provides an overview of the major functions of the phylosamp package, which was designed to help users determine the the ability of some phylogenetic criteria (e.g., genetic distance) to correctly identify pairs of cases linked by transmission, given a particular sample size or proportion. The package also includes functions that do the reverse: calculate the sample size needed to correctly identify true pairs at some particular rate. This vignette covers the following concepts and their associated functions:

1. How to estimate the false discovery rate given a sample size (forward functions)

2. How to estimate the minimum necessary sample size given a desired maximum false discovery rate (reverse functions)

3. How to determine the sensitivity and specificity of a linkage criteria

4. Applications to hypothetical pathogens

All functions require the user to specify the underlying assumptions about transmissions and linkage, i.e., if an infected individual can transmit to more than one susceptible individual (single transmission/multiple transmissions), and if the criteria being used is capable of linking a case to more than one other case (single linkage/multiple linkage). Permitting multiple transmissions and multiple links ('mtml') is the default.


## Estimating the false discovery rate from sample size

The most basic function of the package is `truediscoveryrate`, which calculates the probability that an identified link represents a true transmission event:

```{r truediscoveryrate}

truediscoveryrate(eta=0.99, chi=0.95, rho=0.75, M=100, R=1)

```

In other words, given a sample size of 100 cases (representing 75% of the total population), a linkage criteria with a specificity of 99% for identifying cases linked by  transmission, and a specificity of 95%, less than 25% of identified pairs will represent true transmission events. Increasing the specificity to 99.5% has a significant impact on our ability to distinguish linked and unlinked pairs:

```{r truediscoveryrate2}

truediscoveryrate(eta=0.99, chi=0.995, rho=0.75, M=100, R=1)

```

The other core functions are designed to calculate the expected number of true transmission pairs identified in the sample (`true_pairs`) and the total number of linkages one can expect to identify given the sensitivity and specificity of the linkage criteria and a particular sample size and proportion (`exp_links`).

```{r expected_pairs}

true_pairs(eta=0.99, rho=0.75, M=100, R=1)
exp_links(eta=0.99, chi=0.95, rho=0.75, M=100, R=1)

```

##### Important Note

It is important to recognize that $R$ in these functions represents the average $R$ in the sampled population (alternatively denoted $R_\text{pop}$). Because any sampling frame contains a finite number of cases, there will always be more cases than infection events (at minimum, all infectees in a transmission chain plus a single index case), so $R_\text{pop}\leq1$. For outbreaks with a single introduction, $R_\text{pop}$ is approximately equal to 1; sampling frames containing cases from separate introduction events will have lower values of $R_\text{pop}$.

## Estimating the minimum sample size from the false discovery rate

The package can also be used in reverse; for example, if the samples have yet to be collected but you want to ensure at least 75% confidence in identified links. To calculate the proportion of links that represent true transmission pairs, the user needs to provide the sensitivity and specificity of the linkage criteria used, the final size of the outbreak, and the desired minimum true discovery rate.

Imagine we are interested in collecting enough samples from an outbreak of 100 cases to ensure that the links you identify are correct at least 75% of the time. The phylogenetic criteria we are using to identify links has a sensitivity of 99% and a specificity of 99.5%:

```{r samplesize}

samplesize(eta=0.99, chi=0.995, N=100, R=1, phi=0.75)

```

Although 10 samples will ensure a false discovery rate of no more than 25%, 10 samples may not provide enough data for analysis. In this case, we can use the optional `min_pairs` parameter to require that the expected number of links (calculated using the `exp_links` function) is at least some minimum value:

```{r samplesize_explinks}

samplesize(eta=0.99, chi=0.995, N=100, R=1, phi=0.75, min_pairs=30)

```

In another example, it may be crucial that links are identified with high certainty. So we increase the minimum true discovery rate to 95%:

```{r samplesize_fail, error=TRUE}

samplesize(eta=0.99, chi=0.995, N=100, R=1, phi=0.95)

```

This result suggests it is not possible to obtain such high certainty with this linkage criteria. We can confirm this with the `truediscoveryrate` function, which shows that even with 100% sampling of this outbreak, we will correctly identify transmission links no more than 80% of the time.

```{r truediscoveryrate_explain}

truediscoveryrate(eta=0.99, chi=0.995, rho=1, M=100, R=1)

```

Further exploration of the `samplesize` function reveals that there are limited combinations of sensitivity and specificity that produce reasonable sample sizes, and that specificity in particular affects the minimum false discovery rate that can be obtained. Therefore, correctly estimating sensitivity and specificity are of key importance when using these functions to understand transmission.

## Determining sensitivity and specificity of a linkage criteria

The sensitivity and specificity of the linkage criteria can be determined by applying a specific linkage criteria to an existing dataset for which the true transmission events are known, and then extrapoloating these results to a new or larger set of data for which transmission are not known.

However, there are many scenarios in which this existing dataset is not available or representative of the desired sampling population. In this package, we provide a method for calculating the sensitivity and specificity of genetic distance -- the number of mutations between pathogen genome sequences -- as a linkage criteria. Further research is needed to extend this method beyond genetic distance as the linkage metric.

In this package, we provide a function (`sens_spec_calc`) to calculate the sensitivity and specificity when using a specific genetic distance threshold (e.g. 2 mutations) or a vector of candidate thresholds (e.g. 1-10 mutations). Note that samples separated by a genetic distance of less than the cutoff are considered linked, so the minimum cutoff to consider is 1 (linked cases have identical genomes).

```{r sens_spec_calc}

sens_spec_calc(cutoff=2, mut_rate=1, mean_gens_pdf=c(0.02,0.08,0.15,0.75), max_link_gens=1)

sens_spec_calc(cutoff=1:10, mut_rate=1, mean_gens_pdf=c(0.02,0.08,0.15,0.75), max_link_gens=1)

```

This method requires knowledge of the pathogen mutation rate, the distribution of generations between cases, and the number of generations between cases considered linked. We break down each of these inputs in turn:

##### 1. The mutation rate of the pathogen

The mutation rate of the pathogen must be provided in mutations per generation per genome, and represents the average number of mutations observed between the genomes of an infector/infectee pair.

Many pathogen mutation rates are reported in substitutions per site per year. We provide an example of converting the substitution rate for Ebola virus (roughly $1.2\times 10^{-3} subs/site/year$) to mutations (used interchangeably with substitutions for this purpose) per genome per generation:

$$ 1.2\times 10^{-3}\:subs/site/year \:\times\:\frac{19000\text{ sites}}{1\text{ genome}}
\:\times\:\frac{1\text{ year}}{365\text{ days}}\:\times\:\frac{15\text{ days}}{1\text{ generation}}
= 0.94\:subs/genome/generation$$

In other words, assuming an approximate generation time of 15 days, we would expect to see 1 mutation per generation of transmission.

##### 2. The distribution of generations between cases

The number of generations between all pairs of cases in the population is key to determining how many of them are actually linked (separated by less than `max_link_gens` generations of transmission), which in turn is used to calculate the sensitivity and specificity. This distribution is not trivial, but depends on the reproductive number of the pathogen. We have simulated this distribution for values of $R$ between 1.3 and 18 and averaged the results of 1000 simulations for each value. The results are provided as part of this package at `data/sim_distance_dist.csv` and can be used as a reasonable proxy for the generation distribution for large outbreaks.

We provide an example of using these results for given the mutation rate (~1) and reproductive number (1.5) of an Ebola-like virus:

```{r sens_spec_calc_ebov}

mgd <- read.csv("data/sim_distance_dist.csv")

sens_spec_calc(cutoff=1:10, mut_rate=1, mean_gens_pdf=mgd[mgd["R"]==1.5][3:dim(mgd)[2]], max_link_gens=1)

```

We can then choose the optimal threshold and the associated sensitivity and specificity for our transmission study. Many methods exist for choosing the optimal threshold, including the Youden index, closest to corner, etc. Using either of these methods, the optimal threshold in this example is 5 mutations. In other words, cases separate by less than 5 mutations will be considered linked given this linkage criteria, which has a sensitivity of 98.1% and a specficity of 98.7%.

## Illustrative examples

In this section, we extend the Ebola-like pathogen example from the previous section and use the package functions to compare the results to those of a pathogen with a slower mutation rate and higher reproductive number. We use the function `sens_spec_roc`, which formats the results of `sens_spec_calc` for plotting ROC curves.

```{r gen_dist_compare_ebov, fig.width=4, fig.height=3}

library(ggplot2)
library(reshape2)
library(RColorBrewer)
library(cowplot)

# ebola-like pathogen
R <- 1.5
mut_rate <- 1

# use simulated generation distributions
mgd <- read.csv("data/sim_distance_dist.csv")
mean_gens_pdf <- mgd[mgd["R"]==R][3:dim(mgd)[2]]

# get theoretical genetic distance dist based on mutation rate and generation parameters
dists <- as.data.frame(gen_dists(mut_rate = mut_rate, mean_gens_pdf = mean_gens_pdf, max_link_gens = 1))
# reshape dataframe for plotting
dists <- reshape2::melt(dists, id.vars = "dist", variable.name = "status", value.name = "prob")

# get sensitivity and specificity using the same paramters
roc_calc <- sens_spec_roc(cutoff = 1:(max(dists$dist)-1), mut_rate = mut_rate,
                          mean_gens_pdf = mean_gens_pdf)
  
# get the optimal value for the ROC plot
# use point closest to corner
  
roc_optim <- roc_calc
roc_optim$dist <- sqrt((1-roc_optim$sensitivity)^2 + (roc_optim$specificity)^2)
roc_optim <- roc_optim[2:(dim(roc_optim)[1]),] # remove first row with zero threshold
optim_value <- min(roc_optim$dist)
threshold <- roc_optim[roc_optim$dist==optim_value,]$cutoff
optim_point <- c(roc_optim[roc_optim$cutoff==threshold,]$specificity,
                 roc_optim[roc_optim$cutoff==threshold,]$sensitivity)
  
# plot the distributions of genetic distance
pal <- RColorBrewer::brewer.pal(5, "PuOr")
  
p1 <- ggplot(dists, aes(x=dist, y=prob, fill=status)) +
    geom_bar(alpha=0.5, stat="identity", position="identity") +
    scale_fill_manual(name="", values=c(pal[5], pal[2])) +
    scale_x_continuous(limits = c(-1,35), expand = c(0,0)) +
    scale_y_continuous(limits = c(0,0.4), expand = c(0,0)) +
    xlab('Genetic distance') + ylab('Density') +
    theme_classic() + theme(legend.position='none') +
    geom_vline(xintercept=threshold, linetype=2, size=0.5, color = "black")
  
# add ROC curve on top
r1 <- ggplot(data=roc_calc, aes(x=specificity, y=sensitivity)) +
    geom_line(size=1.5) + xlim(0,1) + ylim(0,1) +
    geom_point(x=optim_point[1], y=optim_point[2],
               size = 3, stroke=1, shape=21, fill = "chartreuse") +
    geom_abline(slope=1, intercept = 0, linetype=2, alpha=0.5) +
    xlab("1-specificity") +
    theme_bw()
  
cowplot::ggdraw(p1) + cowplot::draw_plot(r1, hjust=-0.16, vjust=-0.16, scale=0.6)

```

We repeat the above plot for a pathogen with a higher reproductive number and lower mutation rate:

```{r gen_dist_compare_mev}

# faster-spreading pathogen
R <- 3
mut_rate <- 0.2

mean_gens_pdf <- mgd[mgd["R"]==R][3:dim(mgd)[2]]

```

```{r gen_dist_mev_plot, fig.width=4, fig.height=3, echo=FALSE}

# get theoretical genetic distance dist based on mutation rate and generation parameters
dists <- as.data.frame(gen_dists(mut_rate = mut_rate, mean_gens_pdf = mean_gens_pdf, max_link_gens = 1))
# reshape dataframe for plotting
dists <- reshape2::melt(dists, id.vars = "dist", variable.name = "status", value.name = "prob")

# get sensitivity and specificity using the same paramters
roc_calc <- sens_spec_roc(cutoff = 1:(max(dists$dist)-1), mut_rate = mut_rate,
                          mean_gens_pdf = mean_gens_pdf)
  
# get the optimal value for the ROC plot using closest-to-corner metric
roc_optim <- roc_calc
roc_optim$dist <- sqrt((1-roc_optim$sensitivity)^2 + (roc_optim$specificity)^2)
roc_optim <- roc_optim[2:(dim(roc_optim)[1]),] # remove first row with zero threshold
optim_value <- min(roc_optim$dist)
threshold <- roc_optim[roc_optim$dist==optim_value,]$cutoff
optim_point <- c(roc_optim[roc_optim$cutoff==threshold,]$specificity,
                 roc_optim[roc_optim$cutoff==threshold,]$sensitivity)
  
# plot the distributions of genetic distance
pal <- RColorBrewer::brewer.pal(5, "PuOr")
  
p1 <- ggplot(dists, aes(x=dist, y=prob, fill=status)) +
    geom_bar(alpha=0.5, stat="identity", position="identity") +
    scale_fill_manual(name="", values=c(pal[5], pal[2])) +
    scale_x_continuous(limits = c(-1,35), expand = c(0,0)) +
    scale_y_continuous(limits = c(0,0.4), expand = c(0,0)) +
    xlab('Genetic distance') + ylab('Density') +
    theme_classic() + theme(legend.position='none') +
    geom_vline(xintercept=threshold, linetype=2, size=0.5, color = "black")
  
# add ROC curve on top
r1 <- ggplot(data=roc_calc, aes(x=specificity, y=sensitivity)) +
    geom_line(size=1.5) + xlim(0,1) + ylim(0,1) +
    geom_point(x=optim_point[1], y=optim_point[2],
               size = 3, stroke=1, shape=21, fill = "chartreuse") +
    geom_abline(slope=1, intercept = 0, linetype=2, alpha=0.5) +
    xlab("1-specificity") +
    theme_bw()
  
cowplot::ggdraw(p1) + cowplot::draw_plot(r1, hjust=-0.16, vjust=-0.16, scale=0.6)

```

It is well understood that genetic distance is a much more accurate predictor of transmission linkage for pathogens with higher mutation rates and slower spread, as shown clearly in this example. Genetic distance is clearly not an appropriate metric for all pathogens, but more sophisticated linkage criteria -- espeically those that incorporate epidemiological information as well -- may produce better results.